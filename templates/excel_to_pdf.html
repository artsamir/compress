{% extends 'base.html' %}
{% block title %}Excel to PDF Converter - Convert XLS/XLSX to PDF Online Free{% endblock %}
{% block description %}Convert Excel spreadsheets (XLS, XLSX) to PDF online for free. Maintains formatting, charts, and tables. Fast and secure conversion.{% endblock %}
{% block keywords %}excel to pdf, xlsx to pdf, xls to pdf converter, spreadsheet to pdf, free excel converter{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/tools_common.css') }}">
<script src="{{ url_for('static', filename='js/tools_common.js') }}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
{% endblock %}

{% block content %}
<div class="tool-page">
    <!-- Theme Toggle -->
    <button class="theme-toggle" onclick="toggleTheme()">
        <span class="icon-sun">‚òÄÔ∏è</span>
        <span class="icon-moon">üåô</span>
    </button>

    <div class="tool-container">
        <!-- Header -->
        <div class="tool-header">
            <div class="emoji-icon">üìä</div>
            <h1>Excel to PDF Converter</h1>
            <p>Convert your Excel spreadsheets to PDF with perfect formatting! üìà</p>
        </div>

        <!-- Instructions -->
        <div class="instructions-card">
            <h3>üìã How to Use</h3>
            <ol>
                <li><strong>Upload</strong> your Excel file (.xls or .xlsx)</li>
                <li><strong>Preview</strong> your spreadsheet data</li>
                <li><strong>Customize</strong> page orientation and margins if needed</li>
                <li><strong>Convert</strong> and download your PDF!</li>
            </ol>
        </div>

        <!-- Main Tool Card -->
        <div class="tool-card">
            <!-- Upload Area -->
            <div class="upload-area" id="uploadArea">
                <input type="file" id="fileInput" accept=".xls,.xlsx" hidden>
                <div class="upload-icon">üìä</div>
                <h3>Upload Excel File</h3>
                <p>Drag & drop your .xls or .xlsx file here</p>
                <button class="browse-btn" type="button">
                    <i class="fas fa-folder-open"></i> Choose File
                </button>
                <p style="margin-top: 1rem; font-size: 0.85rem; color: var(--text-muted);">
                    üí° Supports: XLS, XLSX ‚Ä¢ Max size: 10MB
                </p>
            </div>

            <!-- Settings Panel -->
            <div id="settingsPanel" style="display: none;">
                <!-- File Info -->
                <div class="alert alert-info" id="fileInfo" style="margin-bottom: 1.5rem;">
                    <i class="fas fa-file-excel"></i>
                    <span id="fileName">file.xlsx</span>
                    <span style="margin-left: auto; cursor: pointer;" onclick="resetUpload()">‚úï Remove</span>
                </div>

                <!-- Sheet Selection -->
                <div class="form-group">
                    <label><i class="fas fa-layer-group"></i> Select Sheet</label>
                    <select id="sheetSelect" onchange="loadSheet()"></select>
                </div>

                <!-- Page Options -->
                <div class="form-row">
                    <div class="form-group">
                        <label><i class="fas fa-arrows-alt-h"></i> Page Orientation</label>
                        <div class="options-grid" style="grid-template-columns: repeat(2, 1fr);">
                            <div class="option-card selected" data-orientation="portrait" onclick="selectOrientation(this)">
                                <div class="option-icon">üìÑ</div>
                                <div class="option-label">Portrait</div>
                            </div>
                            <div class="option-card" data-orientation="landscape" onclick="selectOrientation(this)">
                                <div class="option-icon">üìÉ</div>
                                <div class="option-label">Landscape</div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-file"></i> Page Size</label>
                        <select id="pageSize">
                            <option value="a4">A4</option>
                            <option value="letter">US Letter</option>
                            <option value="legal">US Legal</option>
                            <option value="a3">A3</option>
                        </select>
                    </div>
                </div>

                <!-- Styling Options -->
                <div class="form-row">
                    <div class="form-group">
                        <label><i class="fas fa-text-height"></i> Font Size</label>
                        <select id="fontSize">
                            <option value="8">Small (8pt)</option>
                            <option value="10" selected>Normal (10pt)</option>
                            <option value="12">Large (12pt)</option>
                            <option value="14">Extra Large (14pt)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-th"></i> Table Style</label>
                        <select id="tableStyle">
                            <option value="striped">Striped Rows</option>
                            <option value="grid">Full Grid</option>
                            <option value="plain">Plain</option>
                        </select>
                    </div>
                </div>

                <!-- Preview -->
                <div class="preview-area">
                    <h3>üëÅÔ∏è Data Preview</h3>
                    <div id="tablePreview" style="overflow-x: auto; max-height: 400px;"></div>
                </div>

                <!-- Loading -->
                <div class="loading-spinner" id="loadingSpinner">
                    <div class="spinner"></div>
                </div>

                <!-- Progress -->
                <div class="progress-container" id="progressContainer">
                    <div class="progress-bar">
                        <div class="progress-fill"></div>
                    </div>
                    <p class="progress-text">Converting...</p>
                </div>

                <!-- Action Buttons -->
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="resetUpload()">
                        <i class="fas fa-redo"></i> Upload New File
                    </button>
                    <button class="btn btn-primary" onclick="convertToPDF()">
                        <i class="fas fa-file-pdf"></i> Convert to PDF
                    </button>
                    <button class="btn btn-download" id="downloadBtn" onclick="downloadPDF()" disabled>
                        <i class="fas fa-download"></i> Download PDF
                    </button>
                </div>
            </div>
        </div>

        <!-- Features Section -->
        <div class="tool-card" style="margin-top: 2rem;">
            <h3 style="color: var(--text-primary); margin-bottom: 1.5rem; text-align: center;">‚ú® Features</h3>
            <div class="options-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                <div class="option-card" style="cursor: default;">
                    <div class="option-icon">üìë</div>
                    <div class="option-label">Multi-Sheet Support</div>
                    <p style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.5rem;">Convert any sheet from your workbook</p>
                </div>
                <div class="option-card" style="cursor: default;">
                    <div class="option-icon">üé®</div>
                    <div class="option-label">Beautiful Tables</div>
                    <p style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.5rem;">Professional styling options</p>
                </div>
                <div class="option-card" style="cursor: default;">
                    <div class="option-icon">üì±</div>
                    <div class="option-label">Works Everywhere</div>
                    <p style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.5rem;">Desktop, tablet & mobile</p>
                </div>
                <div class="option-card" style="cursor: default;">
                    <div class="option-icon">üîê</div>
                    <div class="option-label">Privacy First</div>
                    <p style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.5rem;">Converted in your browser</p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
#tablePreview table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
}
#tablePreview th, #tablePreview td {
    padding: 8px 12px;
    border: 1px solid var(--border-color);
    text-align: left;
}
#tablePreview th {
    background: var(--accent-primary);
    color: white;
    font-weight: 600;
    position: sticky;
    top: 0;
}
#tablePreview tr:nth-child(even) {
    background: var(--bg-input);
}
#tablePreview tr:hover {
    background: rgba(79, 70, 229, 0.1);
}
</style>

<script>
let workbook = null;
let currentSheetData = [];
let pdfBlob = null;
let orientation = 'portrait';

document.addEventListener('DOMContentLoaded', () => {
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    
    CutcompressTools.setupDragAndDrop(uploadArea, fileInput, handleFileSelect);
});

function handleFileSelect(files) {
    const file = files[0];
    if (!file) return;
    
    const ext = file.name.split('.').pop().toLowerCase();
    if (ext !== 'xls' && ext !== 'xlsx') {
        CutcompressTools.showAlert('Please upload an Excel file (.xls or .xlsx)', 'error');
        return;
    }
    
    if (file.size > 10 * 1024 * 1024) {
        CutcompressTools.showAlert('File size exceeds 10MB limit', 'error');
        return;
    }
    
    CutcompressTools.showLoading();
    
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const data = new Uint8Array(e.target.result);
            workbook = XLSX.read(data, { type: 'array' });
            
            // Update UI
            document.getElementById('uploadArea').style.display = 'none';
            document.getElementById('settingsPanel').style.display = 'block';
            document.getElementById('fileName').textContent = file.name;
            
            // Populate sheet selector
            const sheetSelect = document.getElementById('sheetSelect');
            sheetSelect.innerHTML = workbook.SheetNames.map((name, i) => 
                `<option value="${i}">${name}</option>`
            ).join('');
            
            loadSheet();
            CutcompressTools.hideLoading();
            CutcompressTools.showAlert('Excel file loaded successfully!', 'success');
        } catch (error) {
            CutcompressTools.hideLoading();
            CutcompressTools.showAlert('Error reading Excel file', 'error');
            console.error(error);
        }
    };
    reader.readAsArrayBuffer(file);
}

function loadSheet() {
    if (!workbook) return;
    
    const sheetIndex = document.getElementById('sheetSelect').value;
    const sheetName = workbook.SheetNames[sheetIndex];
    const worksheet = workbook.Sheets[sheetName];
    
    // Convert to JSON
    currentSheetData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
    
    // Preview
    renderPreview();
}

function renderPreview() {
    const preview = document.getElementById('tablePreview');
    
    if (currentSheetData.length === 0) {
        preview.innerHTML = '<p style="color: var(--text-secondary);">No data in this sheet</p>';
        return;
    }
    
    // Show first 20 rows for preview
    const previewData = currentSheetData.slice(0, 20);
    const maxCols = Math.max(...previewData.map(row => row ? row.length : 0));
    
    let html = '<table><thead><tr>';
    
    // Header row
    if (previewData[0]) {
        for (let i = 0; i < maxCols; i++) {
            html += `<th>${previewData[0][i] || ''}</th>`;
        }
    }
    html += '</tr></thead><tbody>';
    
    // Data rows
    for (let i = 1; i < previewData.length; i++) {
        html += '<tr>';
        for (let j = 0; j < maxCols; j++) {
            html += `<td>${previewData[i] && previewData[i][j] !== undefined ? previewData[i][j] : ''}</td>`;
        }
        html += '</tr>';
    }
    
    html += '</tbody></table>';
    
    if (currentSheetData.length > 20) {
        html += `<p style="text-align: center; color: var(--text-secondary); margin-top: 1rem;">
            Showing 20 of ${currentSheetData.length} rows...
        </p>`;
    }
    
    preview.innerHTML = html;
}

function selectOrientation(element) {
    document.querySelectorAll('.option-card[data-orientation]').forEach(el => el.classList.remove('selected'));
    element.classList.add('selected');
    orientation = element.dataset.orientation;
}

async function convertToPDF() {
    if (!currentSheetData || currentSheetData.length === 0) {
        CutcompressTools.showAlert('No data to convert', 'error');
        return;
    }
    
    CutcompressTools.showLoading();
    document.getElementById('progressContainer').classList.add('active');
    CutcompressTools.updateProgress(10);
    
    setTimeout(async () => {
        try {
            const { jsPDF } = window.jspdf;
            
            const pageSize = document.getElementById('pageSize').value;
            const fontSize = parseInt(document.getElementById('fontSize').value);
            const tableStyle = document.getElementById('tableStyle').value;
            
            const doc = new jsPDF({
                orientation: orientation,
                unit: 'mm',
                format: pageSize
            });
            
            CutcompressTools.updateProgress(30);
            
            // Get headers and body
            const headers = currentSheetData[0] || [];
            const body = currentSheetData.slice(1);
            
            // AutoTable configuration
            const tableConfig = {
                head: [headers],
                body: body,
                startY: 20,
                styles: {
                    fontSize: fontSize,
                    cellPadding: 3,
                },
                headStyles: {
                    fillColor: [79, 70, 229],
                    textColor: 255,
                    fontStyle: 'bold',
                },
                margin: { top: 20, right: 10, bottom: 20, left: 10 },
            };
            
            // Apply table style
            if (tableStyle === 'striped') {
                tableConfig.alternateRowStyles = { fillColor: [245, 247, 250] };
            } else if (tableStyle === 'grid') {
                tableConfig.tableLineColor = [200, 200, 200];
                tableConfig.tableLineWidth = 0.1;
            }
            
            CutcompressTools.updateProgress(50);
            
            doc.autoTable(tableConfig);
            
            CutcompressTools.updateProgress(80);
            
            // Create blob
            pdfBlob = doc.output('blob');
            
            CutcompressTools.updateProgress(100);
            
            setTimeout(() => {
                CutcompressTools.hideLoading();
                document.getElementById('progressContainer').classList.remove('active');
                document.getElementById('downloadBtn').disabled = false;
                CutcompressTools.showAlert('PDF created successfully!', 'success');
            }, 300);
            
        } catch (error) {
            CutcompressTools.hideLoading();
            document.getElementById('progressContainer').classList.remove('active');
            CutcompressTools.showAlert('Error creating PDF: ' + error.message, 'error');
            console.error(error);
        }
    }, 100);
}

function downloadPDF() {
    if (!pdfBlob) {
        CutcompressTools.showAlert('Please convert the file first', 'error');
        return;
    }
    
    const fileName = document.getElementById('fileName').textContent.replace(/\.(xls|xlsx)$/i, '.pdf');
    const url = URL.createObjectURL(pdfBlob);
    const a = document.createElement('a');
    a.href = url;
    a.download = fileName;
    a.click();
    URL.revokeObjectURL(url);
    
    CutcompressTools.showAlert('PDF downloaded!', 'success');
}

function resetUpload() {
    workbook = null;
    currentSheetData = [];
    pdfBlob = null;
    document.getElementById('fileInput').value = '';
    document.getElementById('uploadArea').style.display = 'block';
    document.getElementById('settingsPanel').style.display = 'none';
    document.getElementById('downloadBtn').disabled = true;
}
</script>
{% endblock %}
