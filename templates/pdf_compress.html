{% extends 'base.html' %}
{% block title %}Compress PDF - Reduce PDF File Size Online Free{% endblock %}
{% block description %}Compress PDF files to reduce file size while maintaining quality. Free online PDF compressor tool.{% endblock %}
{% block keywords %}compress pdf, reduce pdf size, pdf compressor, shrink pdf{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/tools_common.css') }}">
<script src="{{ url_for('static', filename='js/tools_common.js') }}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
{% endblock %}

{% block content %}
<div class="tool-page">
    <button class="theme-toggle" onclick="toggleTheme()">
        <span class="icon-sun">‚òÄÔ∏è</span>
        <span class="icon-moon">üåô</span>
    </button>

    <div class="tool-container">
        <div class="tool-header">
            <div class="emoji-icon">üóúÔ∏è</div>
            <h1>Compress PDF</h1>
            <p>Reduce your PDF file size quickly! üìâ</p>
        </div>

        <div class="instructions-card">
            <h3>üìã How to Use</h3>
            <ol>
                <li><strong>Upload</strong> your PDF file</li>
                <li><strong>Choose</strong> compression level</li>
                <li><strong>Click</strong> Compress</li>
                <li><strong>Download</strong> your smaller PDF!</li>
            </ol>
        </div>

        <div class="tool-card">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üìÑ</div>
                <h3>Drop PDF file here</h3>
                <p>or click to browse</p>
                <input type="file" id="fileInput" accept=".pdf" hidden>
            </div>

            <!-- File Info -->
            <div id="fileInfo" style="display: none; margin-top: 1.5rem;">
                <div style="background: var(--bg-tertiary); padding: 1.5rem; border-radius: 8px;">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                        <span style="font-size: 2rem;">üìÑ</span>
                        <div>
                            <div id="fileName" style="font-weight: 600; color: var(--text-primary);"></div>
                            <div id="fileSize" style="color: var(--text-secondary);"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Compression Level -->
            <div id="compressionOptions" style="display: none; margin-top: 1.5rem;">
                <h3 style="color: var(--text-primary); margin-bottom: 1rem;">‚öôÔ∏è Compression Level</h3>
                <div class="options-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="option-card" data-level="low" onclick="selectLevel(this)">
                        <div class="option-icon">üü¢</div>
                        <div class="option-label">Low</div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary);">Best Quality</div>
                    </div>
                    <div class="option-card selected" data-level="medium" onclick="selectLevel(this)">
                        <div class="option-icon">üü°</div>
                        <div class="option-label">Medium</div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary);">Balanced</div>
                    </div>
                    <div class="option-card" data-level="high" onclick="selectLevel(this)">
                        <div class="option-icon">üî¥</div>
                        <div class="option-label">High</div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary);">Smallest Size</div>
                    </div>
                </div>
            </div>

            <div class="progress-container" id="progressContainer" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <p class="progress-text" id="progressText">Compressing...</p>
            </div>

            <!-- Result -->
            <div id="resultSection" style="display: none; margin-top: 1.5rem;">
                <div style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); padding: 1.5rem; border-radius: 8px; color: white; text-align: center;">
                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚úÖ</div>
                    <h3>Compression Complete!</h3>
                    <div style="display: flex; justify-content: center; gap: 2rem; margin-top: 1rem;">
                        <div>
                            <div style="opacity: 0.8; font-size: 0.9rem;">Original</div>
                            <div id="originalSize" style="font-size: 1.2rem; font-weight: 600;"></div>
                        </div>
                        <div style="font-size: 1.5rem;">‚Üí</div>
                        <div>
                            <div style="opacity: 0.8; font-size: 0.9rem;">Compressed</div>
                            <div id="compressedSize" style="font-size: 1.2rem; font-weight: 600;"></div>
                        </div>
                    </div>
                    <div id="savings" style="margin-top: 0.5rem; font-size: 1.1rem;"></div>
                </div>
            </div>

            <div class="btn-group">
                <button class="btn btn-secondary" onclick="resetTool()">
                    <i class="fas fa-redo"></i> Reset
                </button>
                <button class="btn btn-primary" id="compressBtn" onclick="compressPDF()" disabled>
                    <i class="fas fa-compress"></i> Compress PDF
                </button>
            </div>
        </div>

        <div class="instructions-card" style="margin-top: 2rem;">
            <h3>üí° About PDF Compression</h3>
            <p style="color: var(--text-secondary); line-height: 1.6;">
                This tool optimizes PDF files by removing unused objects, optimizing streams, and cleaning up the document structure. 
                The actual compression ratio depends on the content of your PDF (images, fonts, etc.).
                For PDFs with many images, consider using our image compression tool first.
            </p>
        </div>
    </div>
</div>

<script>
let uploadedFile = null;
let compressionLevel = 'medium';

document.addEventListener('DOMContentLoaded', () => {
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    
    uploadArea.addEventListener('click', () => fileInput.click());
    
    CutcompressTools.setupDragAndDrop(uploadArea, (e) => {
        const file = e.dataTransfer.files[0];
        if (file && file.type === 'application/pdf') {
            handleFile(file);
        }
    });
    
    fileInput.addEventListener('change', (e) => {
        if (e.target.files[0]) {
            handleFile(e.target.files[0]);
        }
    });
});

function handleFile(file) {
    uploadedFile = file;
    
    document.getElementById('fileName').textContent = file.name;
    document.getElementById('fileSize').textContent = CutcompressTools.formatFileSize(file.size);
    
    document.getElementById('fileInfo').style.display = 'block';
    document.getElementById('compressionOptions').style.display = 'block';
    document.getElementById('compressBtn').disabled = false;
    document.getElementById('resultSection').style.display = 'none';
}

function selectLevel(element) {
    document.querySelectorAll('.option-card[data-level]').forEach(el => el.classList.remove('selected'));
    element.classList.add('selected');
    compressionLevel = element.dataset.level;
}

async function compressPDF() {
    if (!uploadedFile) {
        CutcompressTools.showAlert('Please upload a PDF file', 'error');
        return;
    }
    
    const progressContainer = document.getElementById('progressContainer');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    
    progressContainer.style.display = 'block';
    progressFill.style.width = '0%';
    
    try {
        progressText.textContent = 'Loading PDF...';
        progressFill.style.width = '20%';
        
        const arrayBuffer = await uploadedFile.arrayBuffer();
        const { PDFDocument } = PDFLib;
        
        progressText.textContent = 'Analyzing document...';
        progressFill.style.width = '40%';
        
        const pdfDoc = await PDFDocument.load(arrayBuffer, { 
            ignoreEncryption: true,
            updateMetadata: false
        });
        
        progressText.textContent = 'Optimizing...';
        progressFill.style.width = '60%';
        
        // Get compression settings based on level
        const options = {
            useObjectStreams: true,
            addDefaultPage: false,
            objectsPerTick: compressionLevel === 'high' ? 10 : compressionLevel === 'medium' ? 50 : 100
        };
        
        progressText.textContent = 'Saving compressed PDF...';
        progressFill.style.width = '80%';
        
        const compressedBytes = await pdfDoc.save(options);
        const compressedBlob = new Blob([compressedBytes], { type: 'application/pdf' });
        
        progressFill.style.width = '100%';
        progressText.textContent = 'Done!';
        
        // Show results
        const originalSize = uploadedFile.size;
        const compressedSize = compressedBlob.size;
        const savings = ((originalSize - compressedSize) / originalSize * 100).toFixed(1);
        
        document.getElementById('originalSize').textContent = CutcompressTools.formatFileSize(originalSize);
        document.getElementById('compressedSize').textContent = CutcompressTools.formatFileSize(compressedSize);
        document.getElementById('savings').textContent = savings > 0 ? 
            `üéâ Reduced by ${savings}%` : 
            `‚ÑπÔ∏è File is already optimized`;
        
        document.getElementById('resultSection').style.display = 'block';
        
        // Download
        const url = URL.createObjectURL(compressedBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = uploadedFile.name.replace('.pdf', '_compressed.pdf');
        a.click();
        URL.revokeObjectURL(url);
        
        CutcompressTools.showAlert('PDF compressed successfully!', 'success');
        
        setTimeout(() => {
            progressContainer.style.display = 'none';
        }, 2000);
        
    } catch (error) {
        console.error(error);
        CutcompressTools.showAlert('Error compressing PDF: ' + error.message, 'error');
        progressContainer.style.display = 'none';
    }
}

function resetTool() {
    uploadedFile = null;
    document.getElementById('fileInput').value = '';
    document.getElementById('fileInfo').style.display = 'none';
    document.getElementById('compressionOptions').style.display = 'none';
    document.getElementById('resultSection').style.display = 'none';
    document.getElementById('compressBtn').disabled = true;
    CutcompressTools.showAlert('Reset!', 'info');
}
</script>
{% endblock %}
